using System;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.OData.Query;
using Microsoft.AspNetCore.OData.Routing.Controllers;
using CBZ.ContactApp.Data;
using CBZ.ContactApp.Data.Model;
using CBZ.ContactApp.Data.Repository;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;

namespace CBZ.ContactApp.Controllers
{
    [EnableQuery]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status202Accepted)]
    [ProducesResponseType(StatusCodes.Status204NoContent)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public class ContactsController:ODataController
    {
        private readonly ContactDbContext _dbContext;
        private readonly ILogger<ContactsController> _logger;
        private readonly IRepository<Contact> _contactRepository;

        public ContactsController(ContactDbContext context, ILogger<ContactsController> logger,IRepository<Contact> contactRepository)
        {
            _dbContext = context;
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
            _contactRepository = contactRepository;
        }
        
        public ActionResult<IQueryable<Contact>> Get()
        {
            try
            {
                var c=_contactRepository.Get();
                return c == null ? (ActionResult<IQueryable<Contact>>)NoContent() : Ok(c);
            }
            catch (Exception ex)
            {
                _logger.LogError(exception:ex,message:"Get Contacts Error");
            }
            return NotFound();
        }
        
        public ActionResult<Contact> Get(Guid key)
        {
            try
            {
                var c = _contactRepository.Find(key as object);
                if (c.Exception!=null) throw c.Exception;
                return c.Result == null ? (ActionResult<Contact>)NoContent() : Ok(c.Result);
            }
            catch (Exception ex)
            {
                _logger.LogError(exception:ex,message:"Get Contacts Error");
            }
            return NoContent();
        }
        
        [HttpGet]
        public ActionResult<Contact> ByNameSurname(string name,string surname)
        {
            try
            {
                var contacts = _contactRepository.Where(i=>i.Name==name && i.Surname==surname);
                return contacts==null ? (ActionResult<Contact>)NoContent():Ok(contacts);
            }
            catch (Exception e)
            {
                _logger.LogError(e,"Contact.ByNameSurname");
            }
            return NoContent();
        }

        public ActionResult<Contact> Post([FromBody]Contact contact)
        {
            try
            {
                var c=_contactRepository.Add(contact);
                if (c.Exception != null) throw c.Exception;
                return c.Result == null ? (ActionResult<Contact>) BadRequest() : Ok(c.Result);
            }
            catch (Exception exception)
            {
                _logger.LogWarning(exception,"Contact creation problem");
            }
            return NotFound();
        }
        
        public ActionResult<Contact> Put([FromBody]Contact contact)
        {
            try
            {
                var c = _contactRepository.Update(contact);
                if (c.Exception != null) throw c.Exception;
                return c.Result == null ? (ActionResult<Contact>) BadRequest() : Ok(c.Result);
            }
            catch (Exception exception)
            {
                _logger.LogWarning(exception,"Update problem");
            }

            return NotFound();
        }
        
        public ActionResult<Contact> Delete([FromBody]Guid key)
        {
            try
            {
                var cd =_contactRepository.Find(key as object);
                if (cd.Exception != null) throw cd.Exception;
                var c = _contactRepository.Remove(cd.Result);
                if (c.Exception != null) throw c.Exception;
                return c.Result == null ? (ActionResult<Contact>) BadRequest() : Ok(c.Result);
            }
            catch (Exception exception)
            {
                _logger.LogWarning(exception,"Update problem");
            }

            return NotFound();
        }
   
    }
}
